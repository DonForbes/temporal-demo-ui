<!DOCTYPE html>

<html xmlns:th="https://www.thymeleaf.org" th:replace="~{fragments/layout :: layout (~{::body},'home')}">

<head>
    <meta http-equiv="refresh" content="30" />
</head>

<body onload="refreshStatus()">
    <div class="container">
        <div class="card">
            <div class="card-body">
                <div class="col-md-12">
                    <table class="table">
                        <tr>
                            <td>
                                <h2 class="card-title" th:text="'Temporal Demonstrations : ' + ${appName}"
                                    style="color:rgb(102, 179,73);">Temporal Demos : </h2>
                            </td>
                            <td style="text-align: rigt;">
                                <h2 ><button id="transferSubmitBtn" type="button" onclick="newTransfer()">Submit new transfer</button></h2>
                            </td>
                        </tr>
                    </table>
                </div>
                <br>
                <h3>Workflow <i><a th:text=${selectedWorkflow}></a></i> Details</h3>
                <table>
                    <tr>
                        <td>Transfer State</td>
                        <td><a th:text="${moneyTransferState.transferState}"></a></td>
                    </tr>
                    <tr>
                        <td>Workflow Status</td>
                        <td><a id="workflowStatus" th:text="${moneyTransferState.workflowStatus}"></a></td>
                    </tr>
                    <tr>
                        <td>Approval Required</td>
                        <td><a th:text="${moneyTransferState.approvalRequired} ?: 'None'"></a></td>
                    </tr>
                    <tr>
                        <td>Charge Identifier</td>
                        <td><a th:text="${moneyTransferState.moneyTransferResponse.chargeId} ?: 'Not set'"></a></td>
                    </tr>
                </table>

                <label for="progress">Workflow progress:</label>
                <progress class="progress-bar-striped" id="progress" th:value="${moneyTransferState.progressPercentage}"
                    max="100" style="width:100%"></progress>
                <br>
                <hr>
                <h3>Workflows from the last hour</h3>
                <br>
                <table id="workflows" class="table">
                    <thead>
                        <th>Workflow</th>
                        <th>Status</th>
                    </thead>
                    <tbody>
                        <tr th:each="workflow : ${workflows}">
                            <td><a th:href="${workflow.url}" th:text="${workflow.workflowId}"></a></td>
                            <td th:text="${workflow.workflowStatus}"></td>
                        </tr>
                    </tbody>

                </table>
                <div class="form-group">
                    <br />
                    <form action="http://localhost:8090/money-transfer" , id="moneytransferform">
                    </form>
                </div>
            </div>
            <div style="width: 18rem;">
                <div>
                    <h5 class="card-title"></h5>
                    <br>
                    <p><b>
                            <div id="result"></div>
                        </b></p>
                    <br>
                </div>
            </div>
        </div>
    </div>
    <script>
        $("#moneytransferform").submit(function (event) {
            event.preventDefault();

            var $form = $(this),
                firstName = $form.find("input[name='firstName']").val(),
                lastName = $form.find("input[name='lastName']").val(),
                url = $form.attr("action");

            $.ajax({
                'url': url,
                'method': 'POST',
                'dataType': 'json',
                'contentType': 'application/json',
                'data': JSON.stringify({
                    "firstName": firstName,
                    "lastName": lastName
                }),
                success: function (response) {
                    $("#result").empty().append(response);
                }
            });
        });

        function refreshStatus() {
            console.log(document.getElementById('workflowStatus').firstChild.nodeValue);
            if (document.getElementById('workflowStatus').firstChild.nodeValue != "COMPLETED") {
                sleep(3000).then(() => {
                    console.log("Slept for 3, now refreshing screen");
                    location.reload();
                });
            }

        }
        // sleep time expects milliseconds
        function sleep(time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        function newTransfer() {
            window.location.href = "/money-transfer-welcome";
        }
    </script>

</body>

</html>